name: Update N8N Node Documentation

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-docs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      
      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.5.2
      
      - name: Clone n8n repository
        run: |
          echo "ðŸ“¥ Cloning n8n repository..."
          git clone --depth 1 https://github.com/n8n-io/n8n.git /tmp/n8n-repo
          echo "âœ… N8N repository cloned successfully"
      
      - name: Generate N8N documentation
        id: generate
        run: |
          echo "ðŸš€ Starting documentation generation..."
          deno run --allow-read --allow-write scripts/generator.ts
          
          CHANGED_FILES=$(git diff --name-only docs/nodes/ 2>/dev/null | wc -l)
          UNTRACKED_FILES=$(git ls-files --others --exclude-standard docs/nodes/ 2>/dev/null | wc -l)
          TOTAL_CHANGES=$((CHANGED_FILES + UNTRACKED_FILES))
          
          echo "ðŸ“Š Checking for documentation changes..."
          echo "   Modified files: $CHANGED_FILES"
          echo "   Untracked files: $UNTRACKED_FILES" 
          echo "   Total changes: $TOTAL_CHANGES"
          
          if [ "$TOTAL_CHANGES" -gt 0 ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "changed_files=$TOTAL_CHANGES" >> $GITHUB_OUTPUT
            echo "ðŸ“Š Documentation changes detected"
            echo "ðŸ“ Changed files: $TOTAL_CHANGES"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "ðŸ“Š No documentation changes detected"
          fi
      
      - name: Create Pull Request
        if: steps.generate.outputs.changes == 'true'
        id: pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: main
          branch: update-n8n-docs-${{ github.run_number }}
          commit-message: |
            docs: Update N8N node documentation

            - Generated documentation for N8N nodes
            - Updated ${{ steps.generate.outputs.changed_files }} files
            - Source: n8n repository (latest)
            - Generated on: ${{ github.event.repository.updated_at }}

            This is an automated update from the N8N documentation generator.
          title: "docs: Update N8N Node Documentation"
          body: |
            ## ðŸ“š N8N Documentation Update

            This PR contains automatically generated documentation updates for N8N nodes.

            ### ðŸ“Š Summary
            - **Changed Files**: ${{ steps.generate.outputs.changed_files }}
            - **Generated From**: [n8n-io/n8n](https://github.com/n8n-io/n8n) repository
            - **Timestamp**: ${{ github.event.repository.updated_at }}

            ### ðŸ” Review Checklist
            - [ ] Documentation formatting is consistent
            - [ ] Parameter descriptions are accurate
            - [ ] TypeScript interfaces are valid
            - [ ] Workflow examples use correct syntax
            - [ ] Links to official documentation work
            - [ ] No sensitive information exposed

            ### ðŸ¤– Automated Generation
            This documentation was automatically generated using the N8N documentation generator.

            ---
            *This is an automated pull request. Please review the changes before merging.*
          labels: |
            documentation
            automated
            n8n
          assignees: ${{ github.actor }}
          reviewers: ${{ github.actor }}
      
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“Š Documentation Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.generate.outputs.changes }}" == "true" ]; then
            echo "âœ… **Status**: Documentation updated successfully" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“ **Changed Files**: ${{ steps.generate.outputs.changed_files }}" >> $GITHUB_STEP_SUMMARY
            if [ -n "${{ steps.pr.outputs.pull-request-number }}" ]; then
              echo "ðŸ”€ **Pull Request**: #${{ steps.pr.outputs.pull-request-number }}" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ”— **URL**: ${{ steps.pr.outputs.pull-request-url }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â„¹ï¸ **Status**: No documentation changes detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Documentation is already up to date with the latest n8n repository." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")*" >> $GITHUB_STEP_SUMMARY
      
      - name: Cleanup
        if: always()
        run: |
          # Remove cloned n8n repository to save space
          rm -rf /tmp/n8n-repo || true
          echo "ðŸ§¹ Cleanup completed"