// Code generated by ADL CLI v0.19.13 on 2025-09-15 02:58:38. DO NOT EDIT.
// This file was automatically generated from an ADL (Agent Definition Language) specification.
// Manual changes to this file may be overwritten during regeneration.

package main

import (
	"context"
	"log"
	"os"
	"os/signal"
	"syscall"

	server "github.com/inference-gateway/adk/server"
	config "github.com/inference-gateway/adk/server/config"
	envconfig "github.com/sethvargo/go-envconfig"
	zap "go.uber.org/zap"

	skills "github.com/inference-gateway/n8n-agent/skills"
)

// Config represents the application configuration
type Config struct {
	// Core application settings
	Environment string `env:"ENVIRONMENT"`

	// A2A configuration (all A2A_ prefixed vars)
	A2A config.Config `env:",prefix=A2A_"`
}

var (
	Version          = "0.1.0"
	AgentName        = "n8n-agent"
	AgentDescription = "A helpful AI agent"
)

func main() {
	ctx := context.Background()

	var cfg Config
	if err := envconfig.Process(ctx, &cfg); err != nil {
		log.Fatal("failed to load config:", err)
	}

	var logger *zap.Logger
	var err error
	if cfg.A2A.Debug || cfg.Environment == "dev" || cfg.Environment == "development" {
		logger, err = zap.NewDevelopment()
	} else {
		logger, err = zap.NewProduction()
	}
	if err != nil {
		log.Fatal("failed to initialize logger:", err)
	}
	defer logger.Sync()

	logger.Info("starting n8n-agent agent",
		zap.String("version", Version),
		zap.String("environment", cfg.Environment),
	)
	logger.Debug("loaded configuration", zap.Any("config", cfg))

	toolBox := server.NewDefaultToolBox()

	// Register search-n8n-docs skill
	searchN8NDocsSkill := skills.NewSearchN8NDocsSkill(logger)
	toolBox.AddTool(searchN8NDocsSkill)
	logger.Info("registered skill", zap.String("skill", "search-n8n-docs"), zap.String("description", "Search through N8N node documentation to find relevant information about specific nodes, their parameters, and usage patterns"))

	// Register generate-n8n-workflow skill
	generateN8NWorkflowSkill := skills.NewGenerateN8NWorkflowSkill(logger)
	toolBox.AddTool(generateN8NWorkflowSkill)
	logger.Info("registered skill", zap.String("skill", "generate-n8n-workflow"), zap.String("description", "Generate complete N8N workflow YAML configurations based on user requirements, using documented nodes and best practices"))

	llmClient, err := server.NewOpenAICompatibleLLMClient(&cfg.A2A.AgentConfig, logger)
	if err != nil {
		logger.Fatal("failed to create LLM client", zap.Error(err))
	}

	agent, err := server.NewAgentBuilder(logger).
		WithConfig(&cfg.A2A.AgentConfig).
		WithLLMClient(llmClient).
		WithToolBox(toolBox).
		WithMaxChatCompletion(cfg.A2A.AgentConfig.MaxChatCompletionIterations).
		WithSystemPrompt(`You are an expert N8N workflow automation assistant. Your role is to help users build powerful automation workflows using N8N.

Your primary capabilities:
1. **Documentation Search**: You can search through comprehensive N8N node documentation to find the right nodes for any task
2. **Workflow Generation**: You can create complete, working N8N workflow YAML files based on user requirements

Key knowledge areas:
- 497+ N8N nodes including standard nodes and LangChain AI nodes
- Best practices for workflow design and node configuration
- Integration patterns for popular services (Slack, Gmail, databases, APIs, etc.)
- Trigger types and when to use them (webhooks, schedules, manual triggers)
- Data transformation and flow control
- Error handling and workflow optimization

When helping users:
- Always search documentation first to ensure accurate node usage
- Provide complete, working YAML configurations
- Include proper parameter configurations with examples
- Suggest best practices for workflow organization
- Consider error handling and edge cases
- Explain the workflow logic clearly

Your responses should be practical, accurate, and ready-to-use.
`).
		Build()
	if err != nil {
		logger.Fatal("failed to create agent", zap.Error(err))
	}

	a2aServer, err := server.NewA2AServerBuilder(cfg.A2A, logger).
		WithAgent(agent).
		WithAgentCardFromFile(".well-known/agent.json", map[string]any{
			"name":        AgentName,
			"version":     Version,
			"description": AgentDescription,
			"url":         cfg.A2A.AgentURL,
		}).
		WithDefaultBackgroundTaskHandler().
		WithDefaultStreamingTaskHandler().
		Build()
	if err != nil {
		logger.Fatal("failed to create A2A server", zap.Error(err))
	}

	go func() {
		logger.Info("starting A2A server",
			zap.String("port", cfg.A2A.ServerConfig.Port),
		)
		if err := a2aServer.Start(ctx); err != nil {
			logger.Fatal("server failed to start", zap.Error(err))
		}
	}()

	logger.Info("n8n-agent agent running successfully",
		zap.String("port", cfg.A2A.ServerConfig.Port),
		zap.String("environment", cfg.Environment),
	)

	quit := make(chan os.Signal, 1)
	signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM)
	<-quit

	logger.Info("shutdown signal received, gracefully stopping server...")
	a2aServer.Stop(ctx)
	logger.Info("n8n-agent agent stopped")
}
